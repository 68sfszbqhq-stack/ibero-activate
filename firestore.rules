rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // FUNCIÓN SIMPLE Y RÁPIDA
    // ========================================
    
    function isAuth() {
      return request.auth != null;
    }

    // ========================================
    // REGLAS OPTIMIZADAS PARA VELOCIDAD
    // ========================================

    // ÁREAS
    match /areas/{areaId} {
      allow read: if true;
      allow write: if isAuth();
    }

    // EMPLEADOS - REGLA SIMPLE Y RÁPIDA
    match /employees/{employeeId} {
      allow read: if true;
      allow create, delete: if isAuth();
      // MODIFICADO: Permitir actualización de puntos para Feedback
      allow update: if true;
    }

    // ASISTENCIAS
    match /attendances/{attendanceId} {
      allow read, write: if true;
    }

    // FEEDBACKS
    match /feedbacks/{feedbackId} {
      allow read: if isAuth();
      allow create, update, delete: if true;
    }

    // WELLNESS TESTS
    match /wellness_tests/{testId} {
      allow read, write: if true;
    }

    // WELLNESS DATA
    match /wellness_data/{docId} {
      allow read, write: if true;
    }

    // CRISIS ALERTS
    match /crisis_alerts/{docId} {
      allow create: if true;
      allow read, update, delete: if isAuth();
    }

    // ACTIVIDADES
    match /activities/{activityId} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /weekly_schedules/{weekId} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /activity_ratings/{ratingId} {
      allow read, write: if true;
    }

    // PERIODIZACIÓN
    match /program_periodization/{document=**} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    // ========================================
    // SUBCOLLECTIONS - SIMPLIFICADAS
    // ========================================

    match /employees/{employeeId}/attendance/{attendanceId} {
      allow read, write: if true;
    }

    match /employees/{employeeId}/health_surveys/{surveyId} {
      allow read, write: if true;
    }

    match /employees/{employeeId}/feedback/{feedbackId} {
      allow read, write: if true;
    }

    // ANTIGRAVITY WELLNESS MODULE (NUEVO)
    match /employees/{employeeId}/wheel_of_life/{wheelId} {
      allow read, write: if true;
    }

    match /employees/{employeeId}/daily_diary/{diaryId} {
      allow read, write: if true;
    }

    // COLLECTION GROUP QUERIES
    match /{path=**}/attendance/{attendanceId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /{path=**}/feedback/{feedbackId} {
      allow read: if isAuth();
      allow write: if false;
    }

    // ========================================
    // WELLNESS WALKING TRACKER (FASE 1)
    // ========================================
    
    // Estadísticas de caminatas
    // Módulo de caminatas funciona sin login (selección mágica), por eso allow write: if true
    match /walking_stats/{statId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if false;
    }
    
    // Registros de bienestar (resumen por usuario y dia)
    // Permite acceso libre: soporta empleados con y sin login (selección mágica)
    match /wellness_records/{email}/{document=**} {
      allow read, write: if true;
    }

    // ========================================
    // HEALTH MODULE - FASE 2 (NUEVO)
    // ========================================
    
    // Perfiles de salud biométrica
    match /health_profiles/{userId} {
      // El usuario puede leer y escribir su propio perfil
      allow read, write: if isAuth() && 
                            request.auth.uid == userId;
      
      // Admins y coaches pueden leer todos los perfiles (para estadísticas)
      allow read: if isAuth();
      
      // No permitir eliminación (mantener historial médico)
      allow delete: if false;
    }
    
    // Hábitos diarios (hidratación, nutrición, actividad)
    match /daily_habits/{habitId} {
      // El usuario puede leer y escribir sus propios hábitos
      allow read, write: if isAuth() && 
                            resource.data.userId == request.auth.uid;
      
      // Permitir creación si el userId coincide
      allow create: if isAuth() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Admins y coaches pueden leer todos los hábitos
      allow read: if isAuth();
      
      // No permitir eliminación (mantener historial)
      allow delete: if false;
    }
    
    // Historial de peso
    match /weight_history/{entryId} {
      // El usuario puede leer y escribir su propio historial
      allow read, write: if isAuth() && 
                            resource.data.userId == request.auth.uid;
      
      // Permitir creación si el userId coincide
      allow create: if isAuth() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Admins y coaches pueden leer todo el historial
      allow read: if isAuth();
      
      // No permitir eliminación (mantener historial médico)
      allow delete: if false;
    }
    
    // Health Insights (recomendaciones personalizadas)
    match /health_insights/{insightId} {
      // El usuario puede leer sus propios insights
      allow read: if isAuth() && 
                     resource.data.userId == request.auth.uid;
      
      // Solo el sistema puede crear/actualizar insights
      allow write: if isAuth();
      
      // No permitir eliminación
      allow delete: if false;
    }

    // ========================================
    // USERS COLLECTION (Sistema de autenticación)
    // ========================================
    
    match /users/{userId} {
      // El usuario puede leer y actualizar su propio perfil
      allow read, update: if isAuth() && 
                             request.auth.uid == userId;
      
      // Permitir creación durante registro
      allow create: if isAuth() && 
                       request.auth.uid == userId;
      
      // Admins pueden leer todos los usuarios
      allow read: if isAuth();
      
      // No permitir eliminación
      allow delete: if false;
    }


    // ========================================
    // WALKING ATTENDANCE (NUEVO PANEL)
    // ========================================

    match /walking_attendances_log/{docId} {
      allow read, write: if true;
    }

    match /employees/{employeeId}/walking_attendance/{docId} {
      allow read, write: if true;
    }

    match /walking_sessions/{sessionId} {
      allow read, write: if true;
    }

    // Respuestas en vivo durante caminatas (empleados sin login)
    match /walking_live_responses/{docId} {
      allow read, write: if true;
    }

    // Sesión en vivo del instructor
    match /live_walking_sessions/{docId} {
      allow read: if true;
      allow write: if isAuth();
    }

  }
}
